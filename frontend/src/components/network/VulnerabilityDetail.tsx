/**
 * VulnerabilityDetail component.
 *
 * Displays detailed information about a vulnerability in a modal dialog.
 * Shows severity, description, affected service, and remediation steps.
 * Designed for educational purposes with clear explanations.
 */

import type { Vulnerability } from '@/types';
import { SEVERITY_CONFIG } from '@/types';
import { Modal, Badge, Button } from '@/components/common';
import { logger } from '@/services/logger';
import styles from './VulnerabilityDetail.module.css';

/**
 * Props for VulnerabilityDetail component.
 */
export interface VulnerabilityDetailProps {
  /** Vulnerability to display details for */
  vulnerability: Vulnerability | null;
  /** Whether the modal is open */
  isOpen: boolean;
  /** Handler called when modal should close */
  onClose: () => void;
  /** Handler called when "Mark as Fixed" is clicked */
  onMarkFixed?: (vulnerability: Vulnerability) => void;
  /** Handler called when "Learn More" is clicked (for LLM explanation) */
  onLearnMore?: (vulnerability: Vulnerability) => void;
}

/**
 * Get vulnerability type icon.
 */
function getVulnIcon(vulnType: string): string {
  const icons: Record<string, string> = {
    default_credentials: 'ğŸ”‘',
    open_telnet: 'ğŸ“Ÿ',
    open_ftp: 'ğŸ“',
    open_snmp: 'ğŸ“Š',
    unencrypted_http: 'ğŸ”“',
    upnp_enabled: 'ğŸ”Œ',
    open_smb: 'ğŸ“‚',
    open_database: 'ğŸ—„ï¸',
    open_rdp: 'ğŸ–¥ï¸',
    open_vnc: 'ğŸ‘ï¸',
    weak_wifi: 'ğŸ“¶',
    outdated_firmware: 'âš ï¸',
    unnecessary_services: 'ğŸš«',
  };
  return icons[vulnType] || 'âš¡';
}

/**
 * Format timestamp for display.
 */
function formatTimestamp(isoString?: string): string {
  if (!isoString) return 'Unknown';
  try {
    const date = new Date(isoString);
    return date.toLocaleString();
  } catch {
    return 'Unknown';
  }
}

/**
 * Get severity description for educational context.
 */
function getSeverityDescription(severity: string): string {
  const descriptions: Record<string, string> = {
    critical: 'Requires immediate attention. This vulnerability can be exploited easily and may lead to complete system compromise.',
    high: 'Should be addressed soon. This vulnerability poses significant risk and could lead to data breach or system access.',
    medium: 'Should be addressed during regular maintenance. This vulnerability poses moderate risk under certain conditions.',
    low: 'Address when convenient. This vulnerability has limited impact but represents a security weakness.',
    info: 'Informational finding. This is a security observation that may or may not require action.',
  };
  return descriptions[severity] || 'Unknown severity level.';
}

/**
 * VulnerabilityDetail component for showing vulnerability information.
 *
 * @example
 * ```tsx
 * <VulnerabilityDetail
 *   vulnerability={selectedVuln}
 *   isOpen={showVulnDetail}
 *   onClose={() => setShowVulnDetail(false)}
 *   onMarkFixed={(vuln) => markVulnFixed(vuln.id)}
 *   onLearnMore={(vuln) => showLLMExplanation(vuln)}
 * />
 * ```
 */
export function VulnerabilityDetail({
  vulnerability,
  isOpen,
  onClose,
  onMarkFixed,
  onLearnMore,
}: VulnerabilityDetailProps) {
  // Log when vulnerability detail is opened
  if (isOpen && vulnerability) {
    logger.debug('VulnerabilityDetail opened', {
      vulnId: vulnerability.id,
      type: vulnerability.vuln_type,
      severity: vulnerability.severity,
    });
  }

  if (!vulnerability) {
    return null;
  }

  const icon = getVulnIcon(vulnerability.vuln_type);
  const severityConfig = SEVERITY_CONFIG[vulnerability.severity];

  return (
    <Modal
      isOpen={isOpen}
      onClose={onClose}
      title="Vulnerability Details"
      size="lg"
      aria-describedby="vuln-description"
    >
      <div className={styles.detail}>
        {/* Vulnerability Header */}
        <header className={styles.header}>
          <span className={styles.icon} aria-hidden="true">
            {icon}
          </span>
          <div className={styles.headerInfo}>
            <h3 className={styles.title}>
              {vulnerability.title || vulnerability.vuln_type}
            </h3>
            <div className={styles.badges}>
              <Badge severity={vulnerability.severity} size="md">
                {severityConfig.label}
              </Badge>
              {vulnerability.is_fixed && (
                <Badge severity="low" size="md">
                  {vulnerability.verified_fixed ? 'Verified Fixed' : 'Fixed'}
                </Badge>
              )}
              {vulnerability.cve_id && (
                <Badge size="md" className={styles.cveBadge}>
                  {vulnerability.cve_id}
                </Badge>
              )}
            </div>
          </div>
        </header>

        {/* Severity Explanation */}
        <section className={styles.section} aria-labelledby="severity-heading">
          <h4 id="severity-heading" className={styles.sectionTitle}>
            What This Means
          </h4>
          <div
            className={styles.severityBox}
            style={{ borderColor: severityConfig.cssVar }}
          >
            <p className={styles.severityText}>
              {getSeverityDescription(vulnerability.severity)}
            </p>
          </div>
        </section>

        {/* Description */}
        {vulnerability.description && (
          <section className={styles.section} aria-labelledby="desc-heading">
            <h4 id="desc-heading" className={styles.sectionTitle}>
              Description
            </h4>
            <p id="vuln-description" className={styles.description}>
              {vulnerability.description}
            </p>
          </section>
        )}

        {/* Affected Service/Port */}
        {(vulnerability.affected_service || vulnerability.affected_port) && (
          <section className={styles.section} aria-labelledby="affected-heading">
            <h4 id="affected-heading" className={styles.sectionTitle}>
              Affected Service
            </h4>
            <dl className={styles.propertyList}>
              {vulnerability.affected_service && (
                <div className={styles.property}>
                  <dt>Service</dt>
                  <dd>{vulnerability.affected_service}</dd>
                </div>
              )}
              {vulnerability.affected_port && (
                <div className={styles.property}>
                  <dt>Port</dt>
                  <dd className={styles.monospace}>{vulnerability.affected_port}</dd>
                </div>
              )}
            </dl>
          </section>
        )}

        {/* Remediation */}
        {vulnerability.remediation && (
          <section className={styles.section} aria-labelledby="remediation-heading">
            <h4 id="remediation-heading" className={styles.sectionTitle}>
              How to Fix
            </h4>
            <div className={styles.remediationBox}>
              <p className={styles.remediationText}>
                {vulnerability.remediation}
              </p>
            </div>
          </section>
        )}

        {/* Timeline */}
        <section className={styles.section} aria-labelledby="timeline-heading">
          <h4 id="timeline-heading" className={styles.sectionTitle}>
            Timeline
          </h4>
          <dl className={styles.timeline}>
            <div className={styles.timelineItem}>
              <dt>Discovered</dt>
              <dd>{formatTimestamp(vulnerability.discovered_at)}</dd>
            </div>
            {vulnerability.fixed_at && (
              <div className={styles.timelineItem}>
                <dt>Fixed</dt>
                <dd>{formatTimestamp(vulnerability.fixed_at)}</dd>
              </div>
            )}
          </dl>
        </section>

        {/* Actions */}
        <footer className={styles.footer}>
          <div className={styles.footerLeft}>
            {onLearnMore && (
              <Button
                variant="secondary"
                onClick={() => onLearnMore(vulnerability)}
                aria-label="Get AI explanation for this vulnerability"
              >
                ğŸ¤– Learn More
              </Button>
            )}
          </div>
          <div className={styles.footerRight}>
            {!vulnerability.is_fixed && onMarkFixed && (
              <Button
                variant="primary"
                onClick={() => onMarkFixed(vulnerability)}
              >
                Mark as Fixed
              </Button>
            )}
            <Button variant="secondary" onClick={onClose}>
              Close
            </Button>
          </div>
        </footer>
      </div>
    </Modal>
  );
}
