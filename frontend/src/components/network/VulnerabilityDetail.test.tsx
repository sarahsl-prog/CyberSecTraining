/**
 * VulnerabilityDetail component unit tests.
 */

import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen, fireEvent } from '@testing-library/react';
import { VulnerabilityDetail } from './VulnerabilityDetail';
import type { Vulnerability } from '@/types';

describe('VulnerabilityDetail', () => {
  const mockVulnerability: Vulnerability = {
    id: 'vuln-1',
    device_id: 'device-1',
    vuln_type: 'default_credentials',
    severity: 'high',
    title: 'Default Credentials Detected',
    description: 'The device is using default login credentials which can be easily guessed.',
    cve_id: 'CVE-2024-1234',
    affected_service: 'http',
    affected_port: '80',
    remediation: 'Change the default username and password immediately.',
    is_fixed: false,
    verified_fixed: false,
    discovered_at: '2024-12-08T12:00:00Z',
    created_at: '2024-12-08T12:00:00Z',
    updated_at: '2024-12-08T12:00:00Z',
  };

  const defaultProps = {
    vulnerability: mockVulnerability,
    isOpen: true,
    onClose: vi.fn(),
    onMarkFixed: vi.fn(),
    onLearnMore: vi.fn(),
  };

  beforeEach(() => {
    vi.clearAllMocks();
    // Mock dialog methods - jsdom doesn't fully support native dialog
    HTMLDialogElement.prototype.showModal = vi.fn(function (this: HTMLDialogElement) {
      this.setAttribute('open', '');
    });
    HTMLDialogElement.prototype.close = vi.fn(function (this: HTMLDialogElement) {
      this.removeAttribute('open');
    });
  });

  it('renders nothing when vulnerability is null', () => {
    const { container } = render(<VulnerabilityDetail {...defaultProps} vulnerability={null} />);

    expect(container.firstChild).toBeNull();
  });

  it('renders vulnerability title', () => {
    render(<VulnerabilityDetail {...defaultProps} />);

    expect(screen.getByRole('heading', { name: 'Default Credentials Detected' })).toBeInTheDocument();
  });

  it('renders severity badge', () => {
    render(<VulnerabilityDetail {...defaultProps} />);

    expect(screen.getByText('High')).toBeInTheDocument();
  });

  it('renders CVE ID badge when available', () => {
    render(<VulnerabilityDetail {...defaultProps} />);

    expect(screen.getByText('CVE-2024-1234')).toBeInTheDocument();
  });

  it('does not render CVE badge when not available', () => {
    const vulnWithoutCVE = { ...mockVulnerability, cve_id: undefined };
    render(<VulnerabilityDetail {...defaultProps} vulnerability={vulnWithoutCVE} />);

    expect(screen.queryByText(/CVE-/)).not.toBeInTheDocument();
  });

  it('renders severity explanation section', () => {
    render(<VulnerabilityDetail {...defaultProps} />);

    expect(screen.getByText('What This Means')).toBeInTheDocument();
    expect(screen.getByText(/should be addressed soon/i)).toBeInTheDocument();
  });

  it('renders description', () => {
    render(<VulnerabilityDetail {...defaultProps} />);

    expect(screen.getByText('Description')).toBeInTheDocument();
    expect(screen.getByText(/default login credentials/i)).toBeInTheDocument();
  });

  it('renders affected service and port', () => {
    render(<VulnerabilityDetail {...defaultProps} />);

    expect(screen.getByText('Affected Service')).toBeInTheDocument();
    expect(screen.getByText('http')).toBeInTheDocument();
    expect(screen.getByText('80')).toBeInTheDocument();
  });

  it('renders remediation steps', () => {
    render(<VulnerabilityDetail {...defaultProps} />);

    expect(screen.getByText('How to Fix')).toBeInTheDocument();
    expect(screen.getByText(/change the default username/i)).toBeInTheDocument();
  });

  it('renders timeline section', () => {
    render(<VulnerabilityDetail {...defaultProps} />);

    expect(screen.getByText('Timeline')).toBeInTheDocument();
    expect(screen.getByText('Discovered')).toBeInTheDocument();
  });

  it('renders "Mark as Fixed" button for unfixed vulnerabilities', () => {
    render(<VulnerabilityDetail {...defaultProps} />);

    expect(screen.getByRole('button', { name: /mark as fixed/i })).toBeInTheDocument();
  });

  it('does not render "Mark as Fixed" button for fixed vulnerabilities', () => {
    const fixedVuln = { ...mockVulnerability, is_fixed: true };
    render(<VulnerabilityDetail {...defaultProps} vulnerability={fixedVuln} />);

    expect(screen.queryByRole('button', { name: /mark as fixed/i })).not.toBeInTheDocument();
  });

  it('shows "Fixed" badge for fixed vulnerabilities', () => {
    const fixedVuln = { ...mockVulnerability, is_fixed: true };
    render(<VulnerabilityDetail {...defaultProps} vulnerability={fixedVuln} />);

    expect(screen.getByText('Fixed')).toBeInTheDocument();
  });

  it('shows "Verified Fixed" badge when verified', () => {
    const verifiedVuln = { ...mockVulnerability, is_fixed: true, verified_fixed: true };
    render(<VulnerabilityDetail {...defaultProps} vulnerability={verifiedVuln} />);

    expect(screen.getByText('Verified Fixed')).toBeInTheDocument();
  });

  it('calls onMarkFixed when "Mark as Fixed" is clicked', () => {
    render(<VulnerabilityDetail {...defaultProps} />);

    fireEvent.click(screen.getByRole('button', { name: /mark as fixed/i }));

    expect(defaultProps.onMarkFixed).toHaveBeenCalledWith(mockVulnerability);
  });

  it('calls onLearnMore when "Learn More" is clicked', () => {
    render(<VulnerabilityDetail {...defaultProps} />);

    // Button has aria-label not visible text
    fireEvent.click(screen.getByLabelText(/get ai explanation/i));

    expect(defaultProps.onLearnMore).toHaveBeenCalledWith(mockVulnerability);
  });

  it('calls onClose when close button is clicked', () => {
    render(<VulnerabilityDetail {...defaultProps} />);

    // Find the Close button (not the modal's close button)
    const closeButtons = screen.getAllByRole('button', { name: /close/i });
    fireEvent.click(closeButtons[closeButtons.length - 1]); // Click the last Close button

    expect(defaultProps.onClose).toHaveBeenCalledTimes(1);
  });

  it('does not render "Learn More" button when onLearnMore is not provided', () => {
    render(<VulnerabilityDetail {...defaultProps} onLearnMore={undefined} />);

    expect(screen.queryByRole('button', { name: /learn more/i })).not.toBeInTheDocument();
  });

  it('does not render "Mark as Fixed" button when onMarkFixed is not provided', () => {
    render(<VulnerabilityDetail {...defaultProps} onMarkFixed={undefined} />);

    expect(screen.queryByRole('button', { name: /mark as fixed/i })).not.toBeInTheDocument();
  });

  it('displays vulnerability icon based on type', () => {
    render(<VulnerabilityDetail {...defaultProps} />);

    // Default credentials icon
    expect(screen.getByText('ðŸ”‘')).toBeInTheDocument();
  });

  it('renders different severity explanations', () => {
    const criticalVuln = { ...mockVulnerability, severity: 'critical' as const };
    const { rerender } = render(<VulnerabilityDetail {...defaultProps} vulnerability={criticalVuln} />);
    expect(screen.getByText(/immediate attention/i)).toBeInTheDocument();

    const mediumVuln = { ...mockVulnerability, severity: 'medium' as const };
    rerender(<VulnerabilityDetail {...defaultProps} vulnerability={mediumVuln} />);
    expect(screen.getByText(/regular maintenance/i)).toBeInTheDocument();

    const lowVuln = { ...mockVulnerability, severity: 'low' as const };
    rerender(<VulnerabilityDetail {...defaultProps} vulnerability={lowVuln} />);
    expect(screen.getByText(/when convenient/i)).toBeInTheDocument();
  });

  it('shows fixed timestamp when vulnerability is fixed', () => {
    const fixedVuln = {
      ...mockVulnerability,
      is_fixed: true,
      fixed_at: '2024-12-08T14:00:00Z',
    };
    render(<VulnerabilityDetail {...defaultProps} vulnerability={fixedVuln} />);

    // Multiple "Fixed" texts exist (badge and timeline), check for timeline section
    const fixedElements = screen.getAllByText('Fixed');
    expect(fixedElements.length).toBeGreaterThan(0);
  });
});
