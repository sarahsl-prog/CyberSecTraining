"""
Pydantic schemas for vulnerability API.

These schemas define the request and response models for the vulnerability
management endpoints.
"""

from datetime import datetime
from typing import Optional
from enum import Enum
from pydantic import BaseModel, ConfigDict, Field


class SeverityLevel(str, Enum):
    """Vulnerability severity levels."""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


class VulnerabilityBase(BaseModel):
    """Base schema for vulnerability data."""

    vuln_type: str = Field(..., description="Vulnerability type identifier")
    severity: SeverityLevel = Field(..., description="Severity level")
    title: Optional[str] = Field(None, description="Human-readable title")
    description: Optional[str] = Field(None, description="Detailed description")
    cve_id: Optional[str] = Field(None, description="CVE identifier")
    affected_service: Optional[str] = Field(None, description="Affected service name")
    affected_port: Optional[str] = Field(None, description="Affected port number")
    remediation: Optional[str] = Field(None, description="Remediation steps")


class VulnerabilityCreate(VulnerabilityBase):
    """Schema for creating a vulnerability."""

    device_id: str = Field(..., description="ID of the affected device")
    discovered_at: Optional[datetime] = Field(None, description="Discovery timestamp")


class VulnerabilityUpdate(BaseModel):
    """Schema for updating a vulnerability."""

    title: Optional[str] = Field(None, description="Title")
    description: Optional[str] = Field(None, description="Description")
    remediation: Optional[str] = Field(None, description="Remediation steps")
    is_fixed: Optional[bool] = Field(None, description="Fix status")

    model_config = ConfigDict(extra="forbid")


class VulnerabilityMarkFixed(BaseModel):
    """Schema for marking a vulnerability as fixed."""

    is_fixed: bool = Field(True, description="Whether the vulnerability is fixed")
    verified: bool = Field(False, description="Whether the fix was verified by re-scan")


class VulnerabilityResponse(VulnerabilityBase):
    """Schema for vulnerability response."""

    id: str = Field(..., description="Vulnerability ID")
    device_id: str = Field(..., description="Device ID")
    is_fixed: bool = Field(default=False, description="Fix status")
    verified_fixed: bool = Field(default=False, description="Fix verification status")
    discovered_at: Optional[datetime] = Field(None, description="Discovery timestamp")
    fixed_at: Optional[datetime] = Field(None, description="Fix timestamp")
    created_at: Optional[datetime] = Field(None, description="Created timestamp")
    updated_at: Optional[datetime] = Field(None, description="Updated timestamp")

    model_config = ConfigDict(
        from_attributes=True,
        json_schema_extra={
            "example": {
                "id": "550e8400-e29b-41d4-a716-446655440000",
                "device_id": "550e8400-e29b-41d4-a716-446655440001",
                "vuln_type": "default_credentials",
                "severity": "high",
                "title": "Default Credentials Detected",
                "description": "The device is using default login credentials.",
                "cve_id": None,
                "affected_service": "http",
                "affected_port": "80",
                "remediation": "Change the default username and password.",
                "is_fixed": False,
                "verified_fixed": False,
                "discovered_at": "2024-12-08T12:00:00Z",
                "fixed_at": None,
                "created_at": "2024-12-08T12:00:00Z",
                "updated_at": "2024-12-08T12:00:00Z",
            }
        }
    )


class VulnerabilityListResponse(BaseModel):
    """Schema for paginated vulnerability list."""

    items: list[VulnerabilityResponse] = Field(..., description="List of vulnerabilities")
    total: int = Field(..., description="Total vulnerabilities")
    page: int = Field(..., description="Current page")
    page_size: int = Field(..., description="Page size")
    pages: int = Field(..., description="Total pages")


class VulnerabilitySummary(BaseModel):
    """Schema for vulnerability summary statistics."""

    total: int = Field(default=0, description="Total vulnerabilities")
    critical: int = Field(default=0, description="Critical severity count")
    high: int = Field(default=0, description="High severity count")
    medium: int = Field(default=0, description="Medium severity count")
    low: int = Field(default=0, description="Low severity count")
    info: int = Field(default=0, description="Info severity count")
    fixed: int = Field(default=0, description="Fixed count")
    unfixed: int = Field(default=0, description="Unfixed count")

    model_config = ConfigDict(
        json_schema_extra={
            "example": {
                "total": 15,
                "critical": 2,
                "high": 5,
                "medium": 4,
                "low": 3,
                "info": 1,
                "fixed": 3,
                "unfixed": 12,
            }
        }
    )
