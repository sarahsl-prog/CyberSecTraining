"""
Vulnerability model for detected security issues.

This model stores information about vulnerabilities detected on network devices,
including severity levels, remediation information, and fix status.
"""

from datetime import datetime
from sqlalchemy import Column, String, DateTime, ForeignKey, Boolean, Text
from sqlalchemy.orm import relationship

from app.models.base import Base, IdMixin, TimestampMixin


class Severity:
    """Vulnerability severity levels."""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"

    ALL = [CRITICAL, HIGH, MEDIUM, LOW, INFO]


class Vulnerability(Base, IdMixin, TimestampMixin):
    """
    Represents a detected vulnerability on a device.

    Attributes:
        device_id: ID of the affected device
        vuln_type: Type identifier (e.g., "default_credentials", "open_telnet")
        severity: Severity level (critical, high, medium, low, info)
        title: Human-readable title
        description: Detailed description of the vulnerability
        cve_id: CVE identifier if applicable
        affected_service: Name of affected service
        affected_port: Port number if applicable
        remediation: Steps to fix the vulnerability
        is_fixed: Whether the vulnerability has been fixed
        discovered_at: When the vulnerability was detected
        fixed_at: When the vulnerability was fixed
    """

    __tablename__ = "vulnerabilities"

    # Device reference
    device_id = Column(
        String(36),
        ForeignKey("devices.id"),
        nullable=False,
        index=True,
    )

    # Vulnerability identification
    vuln_type = Column(String(100), nullable=False, index=True)
    severity = Column(String(20), nullable=False, index=True)
    title = Column(String(255), nullable=True)
    description = Column(Text, nullable=True)

    # CVE and service information
    cve_id = Column(String(50), nullable=True, index=True)
    affected_service = Column(String(100), nullable=True)
    affected_port = Column(String(10), nullable=True)

    # Remediation
    remediation = Column(Text, nullable=True)

    # Status tracking
    is_fixed = Column(Boolean, default=False, index=True)
    discovered_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    fixed_at = Column(DateTime, nullable=True)
    verified_fixed = Column(Boolean, default=False)

    # Relationships
    device = relationship("Device", back_populates="vulnerabilities")

    def __repr__(self) -> str:
        return f"<Vulnerability(id={self.id}, type={self.vuln_type}, severity={self.severity})>"

    def to_dict(self) -> dict:
        """Convert vulnerability to dictionary."""
        return {
            "id": self.id,
            "device_id": self.device_id,
            "vuln_type": self.vuln_type,
            "severity": self.severity,
            "title": self.title,
            "description": self.description,
            "cve_id": self.cve_id,
            "affected_service": self.affected_service,
            "affected_port": self.affected_port,
            "remediation": self.remediation,
            "is_fixed": self.is_fixed,
            "discovered_at": self.discovered_at.isoformat() if self.discovered_at else None,
            "fixed_at": self.fixed_at.isoformat() if self.fixed_at else None,
            "verified_fixed": self.verified_fixed,
            "created_at": self.created_at.isoformat() if self.created_at else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
        }
